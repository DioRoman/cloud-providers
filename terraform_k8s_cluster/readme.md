# Terraform: Kubernetes HA Cluster in Yandex Cloud

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç **–≤—ã—Å–æ–∫–æ–¥–æ—Å—Ç—É–ø–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä Kubernetes** –≤ **Yandex Cloud**, —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–µ–∫—Ä–µ—Ç–æ–≤, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ KMS –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ Object Storage (S3‚Äë—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º –±–∞–∫–µ—Ç–µ).

***

## üì¶ –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------------|
| `providers.tf` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Terraform backend, –≤–µ—Ä—Å–∏–∏ –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ |
| `variables.tf` | –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ (ID –æ–±–ª–∞–∫–∞, –ø–∞–ø–∫–∏, –∑–æ–Ω—ã –∏ –¥—Ä.) |
| `encrypt.tf` | –°–æ–∑–¥–∞–Ω–∏–µ KMS‚Äë–∫–ª—é—á–∞ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ Kubernetes |
| `service-account.tf` | –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ IAM‚Äë—Ä–æ–ª–µ–π |
| `network.tf` | –°–æ–∑–¥–∞–Ω–∏–µ VPC, –ø–æ–¥—Å–µ—Ç–µ–π –∏ –≥—Ä—É–ø–ø –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |
| `master_k8s.tf` | –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã—Å–æ–∫–æ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes |
| `nodes_k8s.tf` | –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø —É–∑–ª–æ–≤ (worker nodes) –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–æ–Ω |
| `outputs.tf` | –í—ã–≤–æ–¥ –ø–æ–ª–µ–∑–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è (endpoint, kubeconfig –∏ —Ç.–ø.) |

***

## üß± –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### 1. –°–µ—Ç—å (VPC)
- –°–æ–∑–¥–∞—ë—Ç—Å—è VPC `k8s-ha-network`
- 3 –ø–æ–¥—Å–µ—Ç–∏ –≤ –∑–æ–Ω–∞—Ö:
  - `ru-central1-a` ‚Äì `10.5.0.0/16`
  - `ru-central1-b` ‚Äì `10.6.0.0/16`
  - `ru-central1-d` ‚Äì `10.7.0.0/16`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è security group —Å —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–º —Ç—Ä–∞—Ñ–∏–∫–æ–º –¥–ª—è:
  - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —É–∑–ª–æ–≤ (`self_security_group`)
  - –ó–¥–æ—Ä–æ–≤—å—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–≤ (health‚Äëchecks)
  - –î–∏–∞–ø–∞–∑–æ–Ω–∞ NodePort (30000‚Äì32767)
  - ICMP –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 2. KMS (encrypt.tf)
- –°–æ–∑–¥–∞—ë—Ç—Å—è —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π –∫–ª—é—á Yandex KMS:
  - –ê–ª–≥–æ—Ä–∏—Ç–º: `AES_128`
  - –ü–µ—Ä–∏–æ–¥ —Ä–æ—Ç–∞—Ü–∏–∏: 8760 —á–∞—Å–æ–≤ (1 –≥–æ–¥)
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è Kubernetes‚Äë—Å–µ–∫—Ä–µ—Ç–æ–≤.

### 3. –°–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç (service-account.tf)
–°–æ–∑–¥–∞—ë—Ç—Å—è `serviceAccount` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–º –∏ –Ω–æ–¥–∞–º–∏ —Å —Ä–æ–ª—è–º–∏:
- `k8s.clusters.agent`
- `vpc.publicAdmin`
- `container-registry.images.puller`
- `kms.keys.encrypterDecrypter`
- `logging.writer` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–¢–∞–∫–∂–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ API (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è).

### 4. Kubernetes Cluster (master_k8s.tf)
- –ò–º—è: `ha-k8s-cluster`
- –í–µ—Ä—Å–∏—è: `1.32`
- –†–µ–∂–∏–º: **Highly Available** (3 –∑–æ–Ω—ã)
- –†–µ–ª–∏–∑‚Äë–∫–∞–Ω–∞–ª: `REGULAR`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é:
  - –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 22:00 –Ω–∞ 3 —á–∞—Å–∞
- Endpoint –¥–æ—Å—Ç—É–ø–µ–Ω **–ø—É–±–ª–∏—á–Ω–æ** (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
- –°–µ–∫—Ä–µ—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∞ —à–∏—Ñ—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é KMS‚Äë–∫–ª—é—á–∞

### 5. Node Groups (nodes_k8s.tf)
- 3 –≥—Ä—É–ø–ø—ã —É–∑–ª–æ–≤ (`preemptible`, `network‚Äëssd`, `autoscale`)
- –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–π –∑–æ–Ω–µ:
  - `a`: min=3, max=6, initial=3
  - `b`: min=1, max=3
  - `d`: min=1, max=3
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ autorepair
- CPU: 4, RAM: 2–ì–ë, core_fraction: 50%

### 6. Backend (providers.tf)
Terraform‚Äë—Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–∫–µ—Ç–µ **Yandex Object Storage (S3)**:
- –ë–∞–∫–µ—Ç: `dio-bucket`
- –ö–ª—é—á —Å–æ—Å—Ç–æ—è–Ω–∏—è: `terraform-learning/terraform.tfstate`
- DynamoDB‚Äë—Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: `dio-bucket-lock-01`
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `skip_*` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –≤–µ—Ä—Å–∏–µ–π Terraform ‚â•1.6.3.

***

## üß© –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ò–º—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------|-----------|-----------------------|
| `cloud_id` | ID –æ–±–ª–∞–∫–∞ Yandex Cloud | `"b1g2uh898q9ekgq43tfq"` |
| `folder_id` | ID –∫–∞—Ç–∞–ª–æ–≥–∞ (–ø–∞–ø–∫–∏) | `"b1g22qi1cc8rq4avqgik"` |
| `vpc_default_zone` | –°–ø–∏—Å–æ–∫ –∑–æ–Ω | `["ru-central1-a","ru-central1-b","ru-central1-d"]` |

***

## üöÄ –î–µ–ø–ª–æ–π –∫–ª–∞—Å—Ç–µ—Ä–∞

### 1. –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å:
- Terraform >= **1.8**
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `yc` CLI –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞:
  ```bash
  yc init
  ```
- –§–∞–π–ª —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ `~/.authorized_key.json`
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `~/.aws/credentials` –∏ `~/.aws/config` (–¥–ª—è S3 backend)

***

### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
```bash
terraform init
```

***

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–∞
```bash
terraform plan
```

***

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
terraform apply
```

***

### 5. –ü–æ–ª—É—á–µ–Ω–∏–µ kubeconfig
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```bash
terraform output kubeconfig_command
```

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ –≤—ã–≤–æ–¥–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ kubectl, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```bash
yc managed-kubernetes cluster get-credentials ha-k8s-cluster --external
```

***

## üß† –ü–æ–ª–µ–∑–Ω—ã–µ Outputs

| –ò–º—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----------|
| `cluster_id` | ID –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes |
| `cluster_name` | –ò–º—è —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ |
| `kms_key_id` | ID KMS –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è |
| `service_account_id` | ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ |
| `network_id` | ID VPC —Å–µ—Ç–∏ |
| `master_endpoint` | –í–Ω–µ—à–Ω–∏–π endpoint API Kubernetes |
| `master_ca_certificate` | –ö–æ—Ä–Ω–µ–≤–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–ª–∞—Å—Ç–µ—Ä–∞ (sensitive) |
| `kubeconfig_command` | –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ kubeconfig –≤ kubectl |

***

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã Kubernetes —à–∏—Ñ—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é **Yandex KMS**.
- –í—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–¥–µ–ª–µ–Ω–∞ –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é VPC.
- –£–∑–ª—ã –∏–º–µ—é—Ç **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É** (NAT –æ—Ç–∫–ª—é—á–µ–Ω).
- –î–æ—Å—Ç—É–ø –∫ –∫–ª–∞—Å—Ç–µ—Ä—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏.

***

## üßπ –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

–ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã:

```bash
terraform destroy
```

***

## ‚öôÔ∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `public_ip = false` –≤ –±–ª–æ–∫–µ `master`.
- –î–æ–±–∞–≤–∏—Ç—å **NAT‚Äë–∏–Ω—Å—Ç–∞–Ω—Å** –∏–ª–∏ **Cloud NAT** –¥–ª—è –≤—ã—Ö–æ–¥–∞ —É–∑–ª–æ–≤ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.
- –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Yandex Monitoring).
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Ä–æ—Ç–∞—Ü–∏—é –∫–ª—é—á–µ–π KMS (`rotation_period` –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å).
